"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){var e={};e.api={ajaxUrl:null,getShippingMethodExtraLabelNonce:null,getPointsNonce:null,setPointNonce:null,setApiConfiguration:function(e,t,n,o){this.ajaxUrl=e,this.getShippingMethodExtraLabelNonce=t,this.getPointsNonce=n,this.setPointNonce=o},selectPoint:function(e,t,n,o,a,i,r,c,s,l,p,d,u){var h=this,g=new XMLHttpRequest;g.onreadystatechange=function(){if(4===g.readyState){var e=h.getRequestResponse(g);h.isValidResponse(e)?d({data:e.data,name:o,address:i,zipcode:r,city:c,distance:p}):u(e)}},g.open("POST",h.ajaxUrl),g.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),g.responseType="json",g.send("action=bw_set_point&carrier="+encodeURIComponent(e)+"&code="+encodeURIComponent(n)+"&name="+encodeURIComponent(o)+"&address="+encodeURIComponent(i)+"&zipcode="+encodeURIComponent(r)+"&city="+encodeURIComponent(c)+"&country="+encodeURIComponent(s)+"&openingHours="+encodeURIComponent(l)+"&network="+encodeURIComponent(a)+"&packageKey="+encodeURIComponent(t)+"&_wpnonce="+encodeURIComponent(h.setPointNonce))},getParcelPoints:function(e,t,n,o){var a=this,i=new XMLHttpRequest;i.onreadystatechange=function(){if(4===i.readyState){var e=a.getRequestResponse(i);a.isValidResponse(e)?n(e.data):o(e)}},i.open("POST",a.ajaxUrl),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.responseType="json",i.send("action=bw_get_points&carrier="+encodeURIComponent(e)+"&packageKey="+encodeURIComponent(t)+"&_wpnonce="+encodeURIComponent(a.getPointsNonce))},getMapUrl:function(e,t){var n=this,o=new XMLHttpRequest;o.onreadystatechange=function(){if(4===o.readyState){var a=n.getRequestResponse(o);n.isValidResponse(a)?e(a.data.mapUrl):t(a)}},o.open("POST",n.ajaxUrl),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.responseType="json",o.send("action=bw_get_map_url")},getShippingMethodExtraLabel:function(e,t,n,o){var a=this,i=new XMLHttpRequest;i.onreadystatechange=function(){if(4===i.readyState){var e=a.getRequestResponse(i);a.isValidResponse(e)?n(e.data):o(e)}},i.open("POST",a.ajaxUrl),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.responseType="json",i.send("action=bw_get_shipping_method_extra_label&shippingMethod="+encodeURIComponent(e)+"&packageKey="+encodeURIComponent(t)+"&_wpnonce="+encodeURIComponent(a.getShippingMethodExtraLabelNonce))},isValidResponse:function(e){return"object"===(void 0===e?"undefined":_typeof(e))&&null!==e&&!0===e.success&&"data"in e},getRequestResponse:function(e){return"object"===_typeof(e.response)&&null!==e.response?e.response:JSON.parse(e.response)}},e.util={translations:{},initTranslations:function(){var e="undefined"!=typeof wp&&"i18n"in wp;if(this.translations["%skm away"]=e?wp.i18n.__("%skm away","boxtal-connect"):"%skm away",this.translations["Unable to find carrier"]=e?wp.i18n.__("Unable to find carrier","boxtal-connect"):"Unable to find carrier",this.translations["Opening hours"]=e?wp.i18n.__("Opening hours","boxtal-connect"):"Opening hours",this.translations["Choose this parcel point"]=e?wp.i18n.__("Choose this parcel point","boxtal-connect"):"Choose this parcel point",this.translations["Your parcel point:"]=e?wp.i18n.__("Your parcel point:","boxtal-connect"):"Your parcel point:",this.translations["Close map"]=e?wp.i18n.__("Close map","boxtal-connect"):"Close map",this.translations.MONDAY=e?wp.i18n.__("MONDAY","boxtal-connect"):"MONDAY",this.translations.TUESDAY=e?wp.i18n.__("TUESDAY","boxtal-connect"):"TUESDAY",this.translations.WEDNESDAY=e?wp.i18n.__("WEDNESDAY","boxtal-connect"):"WEDNESDAY",this.translations.THURSDAY=e?wp.i18n.__("THURSDAY","boxtal-connect"):"THURSDAY",this.translations.FRIDAY=e?wp.i18n.__("FRIDAY","boxtal-connect"):"FRIDAY",this.translations.SATURDAY=e?wp.i18n.__("SATURDAY","boxtal-connect"):"SATURDAY",this.translations.SUNDAY=e?wp.i18n.__("SUNDAY","boxtal-connect"):"SUNDAY",translations){var t=Object.keys(this.translations),n=!0,o=!1,a=undefined;try{for(var i,r=t[Symbol.iterator]();!(n=(i=r.next()).done);n=!0){var c=i.value;c in this.translations&&this.translations[c]!==translations[c]&&(this.translations[c]=translations[c])}}catch(s){o=!0,a=s}finally{try{!n&&r["return"]&&r["return"]()}finally{if(o)throw a}}}},translate:function(e){var t=e;return t in translations&&(t=this.translations[t]),t},on:function(e,t,n,o){if("undefined"!=typeof jQuery)jQuery(e).on(t,n,o);else{var a=document.querySelector(e);a.addEventListener(t,function(e){for(var t=a.querySelectorAll(n),i=e.target,r=0,c=t.length;r<c;r++)for(var s=i,l=t[r];s&&s!==a;){if(s===l)return o.call(l,e);s=s.parentNode}})}},observeDom:function(e,t,n){var o=void 0;return(o=new MutationObserver(function(e){var o=!0,a=!1,i=undefined;try{for(var r,c=e[Symbol.iterator]();!(o=(r=c.next()).done);o=!0){var s=r.value;if(t(s)){setTimeout(function(){return n()});break}}}catch(l){a=!0,i=l}finally{try{!o&&c["return"]&&c["return"]()}finally{if(a)throw i}}})).observe(e,{childList:!0,subtree:!0,attributes:!0,characterData:!1}),o},formatDistance:function(t){var n=e.util.translate("%skm away"),o=null;return null!==t&&(t=Math.round(t/100)/10,isNaN(t)||(o=" ("+this.sprintf(n,t)+")")),o},formatParcelPoingAddress:function(t,n,o,a){var i=[t,[o,n].filter(function(e){return null!==e}).join(", ")].join(" ");return null!==(a=e.util.formatDistance(a))&&(i+=" "+a),i},fillSpaces:function(e,t){for(;e.length<t;)e+=" ";return e},formatOpeningDays:function(t){for(var n=[],o=e.util.fillSpaces("",11),a=0;a<t.length;a++){var i=t[a];if(i.weekday){for(var r=e.util.translate(i.weekday).charAt(0)+" ",c=i.openingPeriods,s=[],l=0;l<c.length;l++){var p=c[l],d=p.openingTime===undefined?"":p.openingTime,u=p.closingTime===undefined?"":p.closingTime;""!==d&&""!==u?s.push(d+"-"+u):s.push(o)}r+=s.join(" "),a%2==1&&(r='<span style="background-color: #d8d8d8;">'+r+"</span>"),n.push(r)}}return'<pre class="bw-parcel-point-schedule">'+n.join("\n")+"</pre>"},formatHours:function(e){var t=e.split(":");return 3===t.length&&(e=t[0]+":"+t[1]),e},isWoocommerceBlocks:function(){return"wc"in window&&"blocksCheckout"in window.wc&&"wcSettings"in window.wc&&window.wc.wcSettings.getSetting("boxtal-connect-parcel-point_data")},sprintf:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];if("undefined"!=typeof sprintf)return sprintf.apply(undefined,[e].concat(n));var a=!0,i=!1,r=undefined;try{for(var c,s=n[Symbol.iterator]();!(a=(c=s.next()).done);a=!0){var l=c.value;e=e.replace("%s",l)}}catch(p){i=!0,r=p}finally{try{!a&&s["return"]&&s["return"]()}finally{if(i)throw r}}return e})},e.map={mapContainer:null,map:null,markers:[],mapLogoImageUrl:null,mapLogoHrefUrl:null,setMapConfiguration:function(e,t){this.mapLogoImageUrl=e,this.mapLogoHrefUrl=t},buildMapContainer:function(t){var n=this,o=document.createElement("div"),a=e.util.translate("Close map");o.setAttribute("class","bw-close"),o.setAttribute("title",a),o.addEventListener("click",function(){n.close()});var i=document.createElement("div");i.setAttribute("id","bw-map-canvas");var r=document.createElement("div");r.setAttribute("id","bw-map-container"),r.appendChild(i);var c=document.createElement("div");c.setAttribute("id","bw-pp-container");var s=document.createElement("div");s.setAttribute("id","bw-map-inner"),s.appendChild(o),s.appendChild(r),s.appendChild(c);var l=document.createElement("div");l.setAttribute("id","bw-map"),l.appendChild(s),document.body.appendChild(l),n.map=new maplibregl.Map({container:"bw-map-canvas",style:t,zoom:14,accessToken:"whatever"}),n.map.addControl(new maplibregl.NavigationControl);var p=document.createElement("img");p.setAttribute("src",n.mapLogoImageUrl);var d=document.createElement("a");d.setAttribute("href",n.mapLogoHrefUrl),d.setAttribute("target","_blank"),d.appendChild(p);var u=document.createElement("div");u.setAttribute("id","bw-logo"),u.appendChild(d);var h=document.querySelector(".maplibregl-ctrl-top-left");return h&&h.appendChild(u),l},init:function(t){var n=this;n.mapContainer=document.querySelector("#bw-map"),n.mapContainer?t():e.api.getMapUrl(function(e){n.mapContainer=n.buildMapContainer(e),t()},function(e){"object"===(void 0===e?"undefined":_typeof(e))&&"data"in e&&n.showError(e.data.message)})},open:function(){this.mapContainer.classList.add("bw-modal-show");var e=window.pageYOffset+(window.innerHeight-this.mapContainer.offsetHeight)/2;e<window.pageYOffset&&(e=window.pageYOffset),this.mapContainer.style.top=e+"px",this.map.resize()},close:function(){this.mapContainer.classList.remove("bw-modal-show"),this.clearMarkers()},addParcelPointMarkers:function(e){for(var t=0;t<e.length;t++)e[t].index=t,this.addParcelPointMarker(e[t])},addParcelPointMarker:function(t){var n=e.util.translate("Choose this parcel point"),o=e.util.translate("Opening hours"),a='<div class="bw-marker-popup"><b>'+t.parcelPoint.name+'</b><br/><a href="#" class="bw-parcel-point-button" '+this.generateParcelPointTagData(t)+"><b>"+n+"</b></a><br/>"+t.parcelPoint.location.street+", "+t.parcelPoint.location.zipCode+" "+t.parcelPoint.location.city+"<br/><b>"+o+"</b><br/>";a+=e.util.formatOpeningDays(t.parcelPoint.openingDays);var i=this.getMarkerHtmlElement(t.index+1),r=new maplibregl.Popup({offset:25}).setHTML(a),c=new maplibregl.Marker({element:i,anchor:"bottom"}).setLngLat(new maplibregl.LngLat(parseFloat(t.parcelPoint.location.position.longitude),parseFloat(t.parcelPoint.location.position.latitude))).setPopup(r).addTo(this.map);this.markers.push(c),this.addRightColMarkerEvent(c,t.parcelPoint.code)},generateParcelPointTagData:function(e){return' data-code="'+e.parcelPoint.code+'" data-name="'+encodeURIComponent(e.parcelPoint.name)+'" data-network="'+e.parcelPoint.network+'" data-zipcode="'+encodeURIComponent(e.parcelPoint.location.zipCode)+'" data-country="'+encodeURIComponent(e.parcelPoint.location.country)+'" data-city="'+encodeURIComponent(e.parcelPoint.location.city)+'" data-street="'+encodeURIComponent(e.parcelPoint.location.street)+'" data-openinghours="'+encodeURIComponent(JSON.stringify(e.parcelPoint.openingDays))+'" data-distance="'+encodeURIComponent(JSON.stringify(e.distanceFromSearchLocation))+'" '},addRightColMarkerEvent:function(t,n){e.util.on("body","click",".bw-show-info-"+n,function(){t.togglePopup()})},addRecipientMarker:function(e){var t=document.createElement("div");t.className="bw-marker-recipient";var n=new maplibregl.Marker({element:t,anchor:"bottom"}).setLngLat(new maplibregl.LngLat(parseFloat(e.position.longitude),parseFloat(e.position.latitude))).addTo(this.map);this.markers.push(n)},setMapBounds:function(){for(var e=new maplibregl.LngLatBounds,t=0;t<this.markers.length;t++){var n=this.markers[t];e=e.extend(n.getLngLat())}this.map.fitBounds(e,{padding:30,linear:!0})},fillParcelPointPanel:function(t){var n=e.util.translate("Choose this parcel point"),o="";o+="<table><tbody>";for(var a=0;a<t.length;a++){var i=t[a],r=e.util.formatDistance(i.distanceFromSearchLocation);o+="<tr>",o+="<td>"+this.getMarkerHtmlElement(a+1).outerHTML,o+='<div class="bw-parcel-point-title"><a class="bw-show-info-'+i.parcelPoint.code+'">'+i.parcelPoint.name+"</a></div><br/>",o+=i.parcelPoint.location.street+"<br/>",o+=i.parcelPoint.location.zipCode+" "+i.parcelPoint.location.city+(null!==r?r:"")+"<br/>",o+='<a class="bw-parcel-point-button" '+this.generateParcelPointTagData(i)+"><b>"+n+"</b></a>",o+="</td>",o+="</tr>"}o+="</tbody></table>",document.querySelector("#bw-pp-container").innerHTML=o},getMarkerHtmlElement:function(e){var t=document.createElement("div");return t.className="bw-marker",t.innerHTML=e,t},clearMarkers:function(){for(var e=0;e<this.markers.length;e++)this.markers[e].remove();this.markers=[]},getPoints:function(t,n,o){var a=this;e.api.getParcelPoints(t,n,function(e){a.addParcelPointMarkers(e.nearbyParcelPoints),a.fillParcelPointPanel(e.nearbyParcelPoints),a.addRecipientMarker(e.searchLocation),a.setMapBounds()},function(e){"object"===(void 0===e?"undefined":_typeof(e))&&"data"in e&&a.showError(e.data.message)})}},e.blocks={cache:{},loading:!1,init:function(){var t=this,n=(0,window.wc.wcSettings.getSetting)("boxtal-connect-parcel-point_data");if(e.util.initTranslations(),n){e.api.setApiConfiguration(n.ajaxurl,n.getShippingMethodExtraLabelNonce,n.getPointsNonce,n.setPointNonce),e.map.setMapConfiguration(n.mapLogoImageUrl,n.mapLogoHrefUrl);var o=!1;t.onCartChange(function(){t.updateSelectedShippingMethodExtraLabel(),o||(o=!0,jQuery("body").on("input",t.getShippintMethodInputsSelector(),function(){return t.updateSelectedShippingMethodExtraLabel()}))}),jQuery("body").on("click",".bw-select-parcel",function(){e.map.init(function(){e.map.open(),t.getMapPoints()})}),jQuery("body").on("click",".bw-parcel-point-button",function(){var n=wp.i18n.__,o=t.getSelectedShippingMethod(),a=t.getSelectedPackageKey();o||t.showError(n("Unable to find carrier","boxtal-connect")),e.api.selectPoint(o,a,this.getAttribute("data-code"),decodeURIComponent(this.getAttribute("data-name")),this.getAttribute("data-network"),decodeURIComponent(this.getAttribute("data-street")),decodeURIComponent(this.getAttribute("data-zipcode")),decodeURIComponent(this.getAttribute("data-city")),decodeURIComponent(this.getAttribute("data-country")),decodeURIComponent(this.getAttribute("data-openinghours")),decodeURIComponent(this.getAttribute("data-distance")),function(n){var i=n.data;t.updateShippingMethodExtraLabelCache(a,o,i.label),t.refreshShippingMethodExtraLabel(),e.map.close()},function(e){"object"===(void 0===e?"undefined":_typeof(e))&&"data"in e&&t.showError(e.data.message)})})}else console.error("[boxtal-connect] Failed to load plugin configuration (blocks)")},getMapPoints:function(){var t=wp.i18n.__,n=this,o=n.getSelectedShippingMethod(),a=n.getSelectedPackageKey();o&&null!==a||n.showError(t("Unable to find carrier","boxtal-connect")),e.map.getPoints(o,a,function(e){return n.showError(e)})},updateSelectedShippingMethodExtraLabel:function(){var t=wp.i18n.__,n=this;n.refreshShippingMethodExtraLabel();var o=n.getSelectedShippingMethod(),a=n.getSelectedPackageKey();o===undefined||a===undefined||n.loading||(n.loading=!0,e.api.getShippingMethodExtraLabel(o,a,function(e){n.updateShippingMethodExtraLabelCache(a,o,e.label),n.refreshShippingMethodExtraLabel(),n.loading=!1},function(){n.showError(t("Unable to find carrier","boxtal-connect")),n.loading=!1}))},getSelectedShippingMethod:function(){return jQuery(this.getShippintMethodInputsSelector()).filter(":checked").val()},getSelectedPackageKey:function(){var e=0,t=jQuery(this.getShippintMethodInputsSelector()).filter(":checked").attr("name");if(t){var n=t.split("-");e=n[n.length-1]}return e},getShippintMethodInputsSelector:function(){var e=this;return e.getShippingMethodsBlockClasses().map(function(t){return"."+t+" "+e.getShippintMethodsRadioControlSelector()}).join(", ")},getShippintMethodsBlockSelector:function(){return this.getShippingMethodsBlockClasses().map(function(e){return"."+e}).join(", ")},getShippintMethodTextLabelSelector:function(){return".wc-block-components-radio-control__label"},getShippingMethodsBlockClasses:function(){return["wp-block-woocommerce-checkout-shipping-methods-block","wp-block-woocommerce-cart-order-summary-shipping-block","wc-block-components-shipping-rates-control__package"]},getShippintMethodsRadioControlSelector:function(){return".wc-block-components-radio-control input"},showError:function(e){console.error(e)},onCartChange:function(t){var n=this;jQuery(n.getShippintMethodsBlockSelector()).filter(function(e,t){return n.isBlockReady(t)}).length>0&&t(),e.util.observeDom(document.body,function(e){var t=!1;if(e.addedNodes)for(var o=0;o<e.addedNodes.length;o++){var a=e.addedNodes[o];if(n.isBlockReady(a)){t=!0;break}}if(e.removedNodes&&!t)for(var i=0;i<e.removedNodes.length;i++){var r=e.removedNodes[i];if(n.isLoaderBlock(r)){t=!0;break}}return t},t)},isBlockReady:function(e){return this.getShippingMethodsBlockClasses().filter(function(t){return e.classList&&e.classList.contains(t)}).length>0&&jQuery(e).find(this.getShippintMethodsRadioControlSelector()).has(":checked")},isLoaderBlock:function(e){return e.classList&&e.classList.contains("wc-block-components-spinner")},updateShippingMethodExtraLabelCache:function(e,t,n){e in this.cache||(this.cache[e]={}),this.cache[e][t]=n},getShippingMethodCachedExtraLabel:function(e,t){return e in this.cache&&t in this.cache[e]?this.cache[e][t]:null},refreshShippingMethodExtraLabel:function(){var e=this.getSelectedShippingMethod(),t=this.getSelectedPackageKey(),n=this.getShippingMethodCachedExtraLabel(t,e);jQuery(this.getShippintMethodsBlockSelector()).find("label "+this.getShippintMethodTextLabelSelector()).find(".bw-extra-label").remove(),null!==n&&jQuery(this.getShippintMethodsBlockSelector()).find("label").has("input:checked").find(this.getShippintMethodTextLabelSelector()).each(function(e,t){var o=document.createElement("span");o.className="bw-extra-label",o.innerHTML="<br/>"+n,t.appendChild(o)})}},e.legacy={packageKey:null,init:function(){var t=this,n=t.getFrontendData();e.util.initTranslations(),null!==n?(e.api.setApiConfiguration(n.ajaxurl,n.getShippingMethodExtraLabelNonce,n.getPointsNonce,n.setPointNonce),e.map.setMapConfiguration(n.mapLogoImageUrl,n.mapLogoHrefUrl),e.util.on("body","click",".bw-select-parcel",function(n){t.setPackageKey(n),e.map.init(function(){e.map.open(),t.getMapPoints()})}),e.util.on("body","click",".bw-parcel-point-button",function(){var n=e.util.translate("Unable to find carrier"),o=t.getSelectedCarrier();o||t.showError(n),e.api.selectPoint(o,t.packageKey,this.getAttribute("data-code"),decodeURIComponent(this.getAttribute("data-name")),this.getAttribute("data-network"),decodeURIComponent(this.getAttribute("data-street")),decodeURIComponent(this.getAttribute("data-zipcode")),decodeURIComponent(this.getAttribute("data-city")),decodeURIComponent(this.getAttribute("data-country")),decodeURIComponent(this.getAttribute("data-openinghours")),decodeURIComponent(this.getAttribute("data-distance")),function(n){var o=n.name,a=n.address,i=n.zipcode,r=n.city,c=n.distance;t.initSelectedParcelPoint();for(var s=document.querySelectorAll(".bw-parcel-address-"+t.packageKey),l=document.querySelectorAll(".bw-parcel-name-"+t.packageKey),p=0;p<s.length;++p)s[p].innerHTML=e.util.formatParcelPoingAddress(a,r,i,c);for(var d=0;d<l.length;++d)l[d].innerHTML=o;e.map.close()},function(e){"object"===(void 0===e?"undefined":_typeof(e))&&"data"in e&&t.showError(e.data.message)})})):console.error("[boxtal-connect] Failed to load plugin configuration (legacy)")},setPackageKey:function(e){this.packageKey=e.target.attributes.getNamedItem("data-package_key").value},getFrontendData:function(){var e=null;if("undefined"!=typeof bwData)e=bwData;else if("wc"in window&&"wcSettings"in window.wc){var t=window.wc.wcSettings.getSetting("boxtal-connect-parcel-point_data");t&&(e=t)}return e},initSelectedParcelPoint:function(){var t=e.util.translate("Your parcel point:"),n=document.querySelector(".bw-parcel-client-"+this.packageKey);n.innerHTML=t+" ";var o=document.createElement("span");o.setAttribute("class","bw-parcel-name-"+this.packageKey),n.appendChild(o)},getMapPoints:function(){var t=this,n=e.util.translate("Unable to find carrier"),o=t.getSelectedCarrier();o||t.showError(n),e.map.getPoints(o,t.packageKey,function(e){return t.showError(e)})},getSelectedCarrier:function(){var e=void 0,t=document.querySelector('input[type="hidden"].shipping_method');t?e=t.getAttribute("value"):e=document.querySelector("input.shipping_method:checked").getAttribute("value");return e},showError:function(t){e.map.close(),alert(t)}},document.addEventListener("DOMContentLoaded",function(){e.util.isWoocommerceBlocks()?e.blocks.init():e.legacy.init()})}();